@(title: String, currentPage: com.avaje.ebean.Page[Issue], param:IssueApp.SearchCondition, project:Project)

@import helper._
@import utils.TemplateHelper._
@import utils.AccessControl._
@import scala.collection.immutable.Map
@import scala.collection.mutable.ArrayBuffer
@import models.enumeration._

@urlToList = {@routes.IssueApp.issues(project.owner, project.name, param.state, "html", currentPage.getPageIndex + 1)}

@getPageListUrl(pageIndex:Integer) = {@routes.IssueApp.issues(project.owner, project.name, param.state, "html", pageIndex + 1)}

@makeFilterLink(fieldName:String, orderBy:String, orderDir:String, fieldText:String) = {
	@if(orderBy.equals(fieldName)) {
		<a href="@urlToList&orderBy=@fieldName&orderDir=@if(orderDir.equals("desc")){asc}else{desc}" class="filter active"><i class="ico btn-gray-arrow @if(orderDir.equals("desc")){ down }"></i>@fieldText</a>
	} else {
	    <a href="@urlToList&orderBy=@fieldName&orderDir=asc" class="filter"><i class="ico btn-gray-arrow"></i>@fieldText</a>
	}
}

@main(Messages(title), project, utils.MenuType.ISSUE){
<div class="page">
	@prjmenu(project, utils.MenuType.ISSUE, "main-menu-only")
	
	<div class="pull-right">
        <a href="@routes.IssueApp.newIssueForm(project.owner, project.name)" class="nbtn medium orange last">@Messages("issue.menu.new")</a>
    </div>
    
	<ul class="nav nav-tabs nm">
    @for(state <- Array(State.ALL, State.OPEN, State.CLOSED)) {
        <li @if(param.state == state.state) { class="active" }>
            <a href="@routes.IssueApp.issues(project.owner, project.name, state.state)">
                @Messages("issue.state." + state.name.toLowerCase())
                <span class="num-badge">@Issue.countIssues(project.id, state)</span>
            </a>
        </li>
    }
    </ul>

@if(currentPage.getList().size() > 0){
	@if(currentPage.getList().size() > 1){

    <div class="row-fluid">
        <div class="span9">
        	<div class="filter-wrap board pull-right">
        		<div class="filters">
        			@makeFilterLink("state", param.orderBy, param.orderDir, Messages("order.state"))
        			@makeFilterLink("createdDate", param.orderBy, param.orderDir, Messages("order.date"))
        			@makeFilterLink("numOfComments", param.orderBy, param.orderDir, Messages("order.comments"))
        		</div>
        	</div>
        	}
            
            @if(ProjectUser.isMember(UserApp.currentUser().id, project.id)){
                @partial_massupdate(project, param)
            }
            @partial_list(project, currentPage.getList, param, currentPage.getPageIndex, currentPage.getTotalPageCount)
            
            <div id="pagination">
                <!-- pagination.js will fill here. -->
            </div>            
        </div>
        <div class="span3 search-wrap">
            
            <div class="inner bggray">
                <form id="search" action="@routes.IssueApp.issues(project.owner, project.name, param.state)" method="get">
                    <input type="hidden" name="orderBy" value="@param.orderBy" class="h-value order">
                    <input type="hidden" name="state"   value="@param.state">
                    
                    <div class="row-fluid">
                        <div class="span10">
                            <input type="text" name="filter" class="text" placeholder="@Messages("project.searchPlaceholder")" value="@param.filter">
                        </div>
                        <div class="span2">
                            <button type="submit" class="nbtn medium last" style="margin-left:-20px;">@Messages("issue.search")</button>
                        </div>
                    </div>

                    <div class="row">
                        <a href="#" class="btn-advanced"><i class="ico"></i>@Messages("issue.advancedSearch")</a>
                    </div>

                    <div id="advanced-search-form" class="srch-advanced">
                        <dl class="issue-option">
                            <dt>@Messages("author")</dt>
                            <dd><input type="text" name="authorLoginId" class="input-medium"></dd>
                        </dl>
                        <dl class="issue-option">
                            <dt>@Messages("assignee")</dt>
                            <dd>
                                <div class="btn-group" data-name="assigneeId">
                                    <button class="btn dropdown-toggle auto" data-toggle="dropdown">
                                        <span class="d-label">@Messages("order.all")</span>
                                        <span class="d-caret"><span class="caret"></span></span>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li data-value="" data-selected="true" class="active"><a>@Messages("order.all")</a></li>
                                        <li data-value="@User.anonymous.id"><a>@Messages("noAssignee")</a></li>
                                        @for(assignee <- project.assignees) {
                                        <li data-value="@assignee.user.id"><a>@assignee.user.name (@assignee.user.loginId)</a></li>
                                        }
                                    </ul>
                                </div>                                
                            </dd>
                        </dl>
                        <dl class="issue-option">
                            <dt>@Messages("milestone")</dt>
                            <dd>
                                <div class="btn-group" data-name="milestoneId">
                                    <button class="btn dropdown-toggle auto" data-toggle="dropdown">
                                        <span class="d-label">@Messages("milestone.state.all")</span>
                                        <span class="d-caret"><span class="caret"></span></span>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li data-value="" data-selected="true" class="active"><a>@Messages("milestone.state.all")</a></li>
                                        <li data-value="0"><a>@Messages("noMilestone")</a></li>
                                        @for(milestone <- Milestone.findByProjectId(project.id)) {
                                        <li data-value="@milestone.id"><a>@milestone.title</a></li>
                                        }
                                    </ul>
                                </div>                                
                            </dd>
                        </dl>
                    </div>
                    
                    <dl id="labels" class="issue-option">
                        <dt>
                            @Messages("label.select")
                            @if(isProjectResourceCreatable(UserApp.currentUser, project, ResourceType.ISSUE_LABEL)){
                            <button id="manage-label-link" type="button" class="btn-transparent"><i class="icon-cog"></i></button>
                            }
                        </dt>
                        <dd>
                            <fieldset class="labels issue-form-labels"></fieldset>
                        </dd>
                    </dl>
                </form>

                <p class="bottom-actrow">
                    <a href="@routes.IssueApp.issues(project.owner, project.name, param.state, "xls")" class="nbtn white" style="width:100%; padding:6px 0"><i class="ico ico-download"></i>@Messages("issue.downloadAsExcel")</a>
                </p>
            </div>
            
        </div>
    </div>

} else {
	<div class="error-wrap">
		<i class="ico ico-err1"></i>
		<p>@Messages("issue.is.empty")</p>
	</div>
}

    @help.keymap("issueList", project)
</div>

<script type="text/javascript">
    $(document).ready(function(){
        hive.ShortcutKey.setKeymapLink({
           "N": "@routes.IssueApp.newIssueForm(project.owner, project.name)"
           @if(currentPage.getPageIndex > 0){
          ,"A": "@getPageListUrl(currentPage.getPageIndex - 1)"
           }
           @if(currentPage.getTotalPageCount > 1 && (currentPage.getPageIndex + 1 != currentPage.getTotalPageCount)){
          ,"S": "@getPageListUrl(currentPage.getPageIndex + 1)"
           }
        });
    });
</script>

}
