@(post:Posting, commentForm:Form[PostingComment],  project:Project)

@import utils.TemplateHelper._
@import utils.AccessControl._
@import models.enumeration._
@implicitField = @{ helper.FieldConstructor(simpleForm) }

@main("상세보기", project, utils.MenuType.BOARD){

<div class="page board-view">
  @views.html.prjmenu(project, utils.MenuType.BOARD, "main-menu-only")
  
  @** Post Info **@
  <div class="board-header">
    <div class="board-id div">@post.number</div>
    <h1 class="title div">@post.title</h1>
    <div class="date div">@utils.TemplateHelper.agoString(post.ago())</div>
  </div>
  
  @** Content body **@
  <div class="board-body">
    <div class="author-info">
      <a href="@routes.UserApp.userInfo(post.authorLoginId)" class="pull-left img-rounded">
      <img class="user-picture" src="@User.findByLoginId(post.authorLoginId).avatarUrl" width="34" height="34" alt="@post.authorName"></a>
      <div class="media-body">
        <p>
          <a href="@routes.UserApp.userInfo(post.authorLoginId)"><strong>@post.authorLoginId</strong></a> <!--<span class="name">(Loren Brichter)</span>-->
        </p>
        <p class="status">
          <!--Hit <strong class="num">777</strong> 
          -->Comment <strong class="num">@post.numOfComments</strong><!-- 
          Like <i class="ico ico-like-small"></i> <strong class="num">522</strong>-->
        </p>
      </div>
    </div>
    <div class="content" markdown="true">@post.body</div>
    <div class="attachments" resourceType="@ResourceType.BOARD_POST" resourceId="@post.id"></div>
    <!--
      <ul class="attaches wm">
        <li class="attach"><i class="ico ico-clip"></i>K23.png (11KB)</li>
        <li class="attach"><i class="ico ico-clip"></i>K23.png (11KB)</li>
        <li class="attach"><i class="ico ico-clip"></i>K23.png (11KB)</li>
      </ul>-->
  </div>
  <div class="board-footer board-actrow">
  @isAllowed(UserApp.currentUser(), post.asResource(), Operation.UPDATE)){
	<a href="@routes.BoardApp.editPostForm(project.owner, project.name, post.id)" class="n-btn orange med">@Messages("button.edit")</a>
  }
  @isAllowed(UserApp.currentUser(), post.asResource(), Operation.DELETE)){
   	<a href="#deleteConfirm" data-toggle="modal" class="n-btn light-gray med">@Messages("button.delete")</a>
  }
    <a href="@routes.BoardApp.posts(project.owner, project.name)" class="n-btn gray med">@Messages("button.list")</a>
  </div>

@** Comment **@
<div class="board-comment-wrap">
    <div class="comment-header"><strong>Comment</strong> <strong class="num">@post.comments.size()</strong></div>
    
    <ul class="comments">
      @for(comment <-post.comments){
      <li class="comment">
        <a href="@routes.UserApp.userInfo(comment.authorLoginId)" class="pull-left img-rounded">
        <img class="user-picture" src="@User.findByLoginId(comment.authorLoginId).avatarUrl" width="34" height="34" alt="@comment.authorLoginId">
        <div class="media-body">
          @if(isAllowed(UserApp.currentUser(), comment.asResource(), Operation.DELETE)){
          <a class="pull-right close" href="@routes.BoardApp.deleteComment(project.owner, project.name, post.id, comment.id)">&times;</a>
          }
            <p class="commenter">
                <a href="@routes.UserApp.userInfo(comment.authorLoginId)"><strong>@comment.authorLoginId</strong></a>
                <span class="date"> @utils.TemplateHelper.agoString(comment.ago())</span>
            </p>
            <div class="comment-body" markdown="true">@comment.contents</div>
            <div class="attachments" resourceType="@ResourceType.NONISSUE_COMMENT" resourceId="@comment.id"></div>
            <!--
            <ul class="attaches">
                <li class="attach"><i class="ico ico-clip"></i><a href="/file-down">첨부파일(iabcde-test.exe) <i class="ico ico-blue-dot"></i> Donwload</a></li>
            </ul>-->
        </div>
      </li>
      }
    </ul>
    
@if(isCreatable(User.findByLoginId(session.get("loginId")), project, models.enumeration.ResourceType.BOARD_POST)){
    <div class="write-comment-box">
        @helper.form(routes.BoardApp.newComment(project.owner, project.name, post.id), 'class->"nm", 'enctype -> "multipart/form-data"){
		<div class="write-comment-wrap">
			@helper.textarea(commentForm("contents"), 'class->"text comment", 'markdown->true)
			<button class="comment-btn">@Messages("button.comment.new")</button>
		</div>
        
		<div class="attach-wrap">
			<div class="thumb-wrap">
			@if(UserApp.currentUser() != UserApp.anonymous) {
				<img src="@User.findByLoginId(session.get("loginId")).avatarUrl" class="img-rounded" width="32" height="32" alt="avatar">
			} else {
				<img src="@routes.Assets.at("images/default-avatar-34.png")" class="img-rounded" width="32" height="32" alt="avatar">
			}
			</div>
			
			@** fileUploader **@
            @if(UserApp.currentUser() != UserApp.anonymous) {

			<div id="upload" class="attach-info-wrap" resourceType="@ResourceType.NONISSUE_COMMENT">
				<div>
					<span class="progress-num">0%</span> <span class="sp-line">&nbsp;</span>
					<strong>total</strong> <span class="total-num">0Mb</span>
				</div>
				<div class="progress-wrap">
					<div class="progress n4">
						<div class="bar orange" style="width: 0%;"></div>
					</div>
				</div>
				<!-- <a href="#!/cancel"><i class="ico btn-cancel"></i></a> -->
			</div>
			
			<div class="btn-wrap">
				<div class="ns-btn fake-file-wrap">
					<i class="ico ico-plus-blue"></i>UPLOAD <input type="file" class="file" name="filePath">
				</div>
			</div>
			}
			@** end of fileUploader **@
        
		</div>
		} @** end of comment form **@
		<div class="attached-files-wrap">
           <ul class="attached-files"></ul>
		</div>
  </div>
  <script type="text/template" id="tplAttachedFile"><!--
	--><li class="attached-file" data-name="${fileName}" data-href="${fileHref}" data-mime="${mimeType}" data-size="${fileSize}">
		<strong>${fileName}(${fileSizeReadable})</strong><!--
		--><a class="attached-delete"><i class="ico btn-delete"></i></a>
	</li>
  </script>
@** end of write-comment-box **@
} else {
	<div class="write-comment-box">
		<div class="write-comment-wrap">
			<textarea class="text comment disabled" disabled="disabled">@Messages("auth.unauthorized.comment")</textarea>
			<button class="comment-btn disabled">@Messages("button.comment.new")</button>
		</div>
	</div>
}
</div>

<div class="board-footer">
	@isAllowed(UserApp.currentUser(), post.asResource(), Operation.UPDATE)){
	<a href="@routes.BoardApp.editPostForm(project.owner, project.name, post.id)" class="n-btn orange med">@Messages("button.edit")</a>
	}

	@isAllowed(UserApp.currentUser(), post.asResource(), Operation.DELETE)){
   	<a href="#deleteConfirm" data-toggle="modal" class="n-btn light-gray med">@Messages("button.delete")</a>
	}

    <a href="@routes.BoardApp.posts(project.owner, project.name)" class="n-btn gray med">@Messages("button.list")</a>
</div>

@** Confirm to delete post **@
<div id="deleteConfirm" class="modal hide fade">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal">×</button>
		<h3>@Messages("button.confirm")</h3>
	</div>
	<div class="modal-body">
		<p>@Messages("post.delete.confirm")</p>
	</div>
	<div class="modal-footer">
		<a class="btn btn-danger med"
			href="@routes.BoardApp.deletePost(project.owner, project.name, post.id)">@Messages("button.yes")</a>
		<a href="#" class="btn med" data-dismiss="modal">@Messages("button.no")</a>
	</div>
</div>

@views.html.markdown()

<script type="text/javascript">
	//nforge.require('shortcut.submit');
	//nforge.require('board.view', "@routes.AttachmentApp.newFile");
	
	$(document).ready(function(){
		$hive.loadModule("board.View", {
			"sAction": "@routes.AttachmentApp.newFile"
		});		
	});
	
</script>
}