@(project: Project, commit:playRepository.Commit, patch: String)

@import playRepository.RepositoryService
@import java.net.URLEncoder
@import utils.TemplateHelper._
@import utils.JodaDateUtil._

@branchItemType(itemType:String) = @{
    if(itemType == "heads"){
        "branch"
    } else {
        itemType
    }
}

@makeBranchItem(project:Project, branch:String) = {
    @defining(branch.split('/')){ names =>
        @if(names(0).equals("refs") && names.length == 3){
            <li data-value="@branch"><a href="@routes.CodeHistoryApp.history(project.owner, project.name, URLEncoder.encode(names(2), "UTF-8"))"><!--
             --><span class="label @branchItemType(names(1))">@branchItemType(names(1))</span><!--
             -->@names(2)
            </a></li>
        } else {
            <li data-value="@branch"><a href="@routes.CodeHistoryApp.history(project.owner, project.name, URLEncoder.encode(branch, "UTF-8"))">@branch</a></li>
        }
    }
}

@main(Messages("code.commits") + " @" + commit.getId, project, utils.MenuType.CODE) {

<div class="page">

	@prjmenu(project, utils.MenuType.CODE, "main-menu-only")

	<div class="code-browse-wrap">
        <div id="branches" class="btn-group branches pull-right" data-name="branch" data-activate="manual">
            <button class="btn dropdown-toggle large" data-toggle="dropdown">
                <span class="d-label"></span>
                <span class="d-caret"><span class="caret"></span></span>
            </button>
            <ul class="dropdown-menu">
            @defining(RepositoryService.getRepository(project).getBranches()) { branches =>
                @for(branch <- branches){
                    @makeBranchItem(project, branch)
                }
            }
            </ul>
        </div>
           
	    <ul class="nav nav-tabs" style="margin-bottom:20px;">
	        <li>
                <a href="@routes.CodeApp.codeBrowser(project.owner, project.name)">@Messages("code.files")</a>
	        </li>
	        <li class="active">
                <a href="@routes.CodeHistoryApp.historyUntilHead(project.owner, project.name)">@Messages("code.commits")</a>
	        </li>
	        <li>
                <strong class="commitId">@@@commit.getId</strong>
	        </li>
	    </ul>

        <pre>@commit.getMessage</pre>
        <p>
        @(commit.getAuthor, commit.getAuthorEmail, commit.getAuthorName) match {
        case (user: User, _, _) if !user.isAnonymous => {
        <a href="@routes.UserApp.userInfo(commit.getAuthor.loginId)" class="avatar-wrap">
            <img src="@commit.getAuthor.avatarUrl" alt="@commit.getAuthor.name" width="32" height="32"/>
        </a>
        <span>@commit.getAuthor.name</span>
        }
        case (_, email, name) if email != null => {
        <span class="avatar-wrap">
            <img class="user-picture" src="@urlToPicture(commit.getAuthorEmail, 32)">
        </span>
        @if(name != null) {
        <span>@name</span>
        }
        }
        case (_, _, name) if name != null => {
        <span>@name</span>
        }
        case (_, _, _) => {
        <span>@User.anonymous.name</span>
        }
        }
        | <span>@agoString(ago(commit.getAuthorDate))</span>
        </p>
		<div id="commit" style="display: none">@patch</div>
	</div>
	
	<a href="javascript: history.back();" class="nbtn medium pull-right">@Messages("button.list")</a>
	
</div>
<script type="text/javascript" src="@getJSLink("lib/diff")"></script>
<script type="text/javascript">
	$(document).ready(function(){
		$hive.loadModule("code.Diff");
	});
</script>
}
